## Pearson’s chi-squared test for individual-level data
We can use Stata to perform the Chi-squared test on the individual-level data in `mod06_nausea.dta`. In this dataset `group` is coded as "1=Active" and "0 = Placebo" and `side_effect` is coded as "1 = Nausea" and "0 = No nausea".

Follow the steps: **Statistics > Summaries, tables, and tests > Frequency tables > Two-way table with measures of association**. In the `tabulate2` dialog box, select the variable `group` in the **Row** variable box, and the variable `side_effect` in the **Column** variable box as shown below. Tick **Pearson’s chi-squared** to obtain the Pearson’s chi-squared test or tick **Fisher’s exact test** if you have small expected cell counts (see Course Notes).

To request for expected frequencies, tick the box for **Expected frequencies** and to request for the row percentage tick the box for **Within-row relative frequencies**.

```{r tabulate2-1, echo=FALSE, out.width = "66%"}
knitr::include_graphics(here::here("img", "mod07", "stata", "tabulate2-1.png"))
```

[Command: `tab group side_effect, chi2 expected row`]

Click **OK** or **Submit** to obtain the following output.

```{r, echo=TRUE, eval=FALSE, highlight=FALSE}
+--------------------+
| Key                |
|--------------------|
|     frequency      |
| expected frequency |
|   row percentage   |
+--------------------+

           |      Side effect
     Group | No nausea     Nausea |     Total
-----------+----------------------+----------
   Placebo |        46          4 |        50 
           |      40.5        9.5 |      50.0 
           |     92.00       8.00 |    100.00 
-----------+----------------------+----------
    Active |        35         15 |        50 
           |      40.5        9.5 |      50.0 
           |     70.00      30.00 |    100.00 
-----------+----------------------+----------
     Total |        81         19 |       100 
           |      81.0       19.0 |     100.0 
           |     81.00      19.00 |    100.00 

          Pearson chi2(1) =   7.8622   Pr = 0.005
```


The last line labelled Pearson chi2(1) reports the appropriate Chi-squared test statistic which has a value of 7.862 with 1 degree of freedom and a P value of 0.005.

Note that while the `tab2` command will perform the chi-square test, the measure of effect is best obtained using the `cs` or `cc` commands, as discussed in Module 6.

## Pearson’s chi-squared test for summarised data

When you only have the cross-tabulated data, you can use the `tabi` command from **Statistics > Summaries, tables, and tests > Frequency tables > Table calculator**. In the `tabi` dialog box, enter the table in the **User-supplied cell frequencies** box as `46 4 \ 35 15` to obtain the same table as above. As explained in the dialog box, each row of frequencies is separated by the backslash “\”. You can tick the same additional outputs and tests as in the tab2 command above.

```{r tabi-1, echo=FALSE, out.width = "66%"}
knitr::include_graphics(here::here("img", "mod07", "stata", "tabi-1.png"))
```

[Command: `tabi 46 4 \ 35 15, chi2 exp row`]

When you are done, click **OK** or **Submit**.

## Chi-squared test for tables larger than 2-by-2
Use the data in `mod07_allergy.dta`. We use similar steps as described above for a 2-by-2 table. Here we have defined the column based on sex, and we would like to obtain allergy severity by sex, so we choose "Within-column relative frequencies". We also request the expected cell counts to check the Pearson chi-squared test assumption that <20% of cells have expected cell count <5 and the minimum expected cell count is >1.

```{r tabulate2-2, echo=FALSE, out.width = "66%"}
knitr::include_graphics(here::here("img", "mod07", "stata", "tabulate2-2.png"))
```

[Command: `tab allergy_severity sex, chi2 col exp`]

Click **OK** or **Submit** to obtain the following output.

```{r, tidy=FALSE, eval=FALSE, highlight=FALSE }
. tabulate allergy_severity sex, column expected

+--------------------+
| Key                |
|--------------------|
|     frequency      |
| expected frequency |
| column percentage  |
+--------------------+

     Severity of |          Sex
         allergy |    Female       Male |     Total
-----------------+----------------------+----------
    Non-allergic |       150        137 |       287 
                 |     138.9      148.1 |     287.0 
                 |     61.98      53.10 |     57.40 
-----------------+----------------------+----------
  Slight allergy |        50         70 |       120 
                 |      58.1       61.9 |     120.0 
                 |     20.66      27.13 |     24.00 
-----------------+----------------------+----------
Moderate allergy |        27         32 |        59 
                 |      28.6       30.4 |      59.0 
                 |     11.16      12.40 |     11.80 
-----------------+----------------------+----------
  Severe allergy |        15         19 |        34 
                 |      16.5       17.5 |      34.0 
                 |      6.20       7.36 |      6.80 
-----------------+----------------------+----------
           Total |       242        258 |       500 
                 |     242.0      258.0 |     500.0 
                 |    100.00     100.00 |    100.00

          Pearson chi2(3) =   4.3089   Pr = 0.230
```

The Pearson chi-squared statistic provides a P-value of 0.23. Therefore, there is little evidence of an association between gender and the severity of allergy.


## McNemar’s test for paired proportions

To perform this test in Stata, we will use the dataset `mod07_drug_response.dta`. Responses to each drug should be in separate variables in the dataset as shown in Table 7.2 using the `tabulate2` command (**Statistics > Summaries, tables, and tests > Frequency tables > Two-way table with measures of association**). In the tabulate2 dialog box, tick **Relative frequencies** under **Cell contents** as shown below.

```{r tabulate2-3, echo=FALSE, out.width = "66%"}
knitr::include_graphics(here::here("img", "mod07", "stata", "tabulate2-3.png"))
```

[Command: `tab2 drugb druga , cell`]

Click **OK** or **Submit** to obtain the following output:

```{r, echo=TRUE, eval=FALSE, highlight=FALSE}
. tabulate druga drugb, cell

+-----------------+
| Key             |
|-----------------|
|    frequency    |
| cell percentage |
+-----------------+

  Response |  Response to Drug B
 to Drug A |        No        Yes |     Total
-----------+----------------------+----------
        No |         5         14 |        19 
           |      8.33      23.33 |     31.67 
-----------+----------------------+----------
       Yes |        20         21 |        41 
           |     33.33      35.00 |     68.33 
-----------+----------------------+----------
     Total |        25         35 |        60 
           |     41.67      58.33 |    100.00 
```

To perform the McNemar’s test, go to **Statistics > Epidemiology and related > Tables for epidemiologists > Matched case-control studies**. In the `mcc` dialog box, select the variable `druga` as the **Exposed case variable** and `drugb` as the **Exposed control variable** as shown below.

```{r mcc-1, echo=FALSE, out.width = "66%"}
knitr::include_graphics(here::here("img", "mod07", "stata", "mcc-1.png"))
```

[Command: `mcc druga drugb`]

Click **OK** or **Submit** when you are done to obtain the following output:

```{r, echo=TRUE, eval=FALSE, highlight=FALSE}
. mcc druga drugb

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        21          20  |         41
       Unexposed |        14           5  |         19
-----------------+------------------------+-----------
           Total |        35          25  |         60

McNemar's chi2(1) =      1.06    Prob > chi2 = 0.3035
Exact McNemar significance probability       = 0.3915

Proportion with factor
        Cases       .6833333
        Controls    .5833333     [95% Conf. Interval]
                   ---------     --------------------
        difference        .1     -.1054528   .3054528
        ratio       1.171429      .8663498   1.583939
        rel. diff.       .24     -.1585239   .6385239

        odds ratio  1.428571      .6862537   3.057277   (exact)
```

Two versions of the McNemar's test are given in the output. The McNemar's chi-squared statistic is generally recommended, unless the sum of the discordant cells is small (Kirkwood and Sterne define small as less than <10; Section 21.3, Kirkwood and Sterne 2001)). The P value for the McNemar test is 0.3, providing no evidence against the null hyopthesis.

